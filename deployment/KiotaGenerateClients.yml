parameters:
  - name: outputDirectory
    type: string
  - name: language
    type: string
    default: 'csharp'
  - name: openApiRepo
    type: string
  - name: openApiBranch
    type: string
    default: 'main'
  - name: openApiSpecPath
    type: string
  - name: GeneratedApiClassName
    type: string
  - name: Namespace
    type: string

steps:
  - task: UseDotNet@2
    displayName: 'Install .NET SDK for Kiota'
    inputs:
      packageType: sdk
      version: '8.0.x'

  - script: dotnet tool install --global Microsoft.OpenApi.Kiota
    displayName: 'Install Kiota CLI'

  - powershell: |
      Write-Host "Root Checkout:"
      Get-ChildItem -Recurse $(Build.SourcesDirectory) | Foreach-Object { $_.FullName }
      Write-Host "'nDeployment Folder"
      if (Test-Path $(Build.SourcesDirectory)\openApiSpecPath)
      {
        Get-ChildItem -Recurse $(Build.SourcesDirectory)\openApiSpecPath | Foreach-Object { $_.FullName }
      }
      else{ Write-Host "not found"}
    displayName: 'List source directory contents'

  - powershell: |
      Write-Host "##vso[task.setvariable variable=PATH]$env:PATH;$env:USERPROFILE\.dotnet\tools"
    displayName: 'Set PATH for Kiota CLI'

  - powershell: |
      $cmd = "kiota generate "
      + ` " --openapi $(Build.SourcesDirectory)/${{ parameters.openApiSpecPath }} "
      + ` " --output ${{ parameters.outputDirectory }} "
      + ` " --language ${{ parameters.language }} "
      + ` " --class-name ${{ parameters.GeneratedApiClassName }} "
      + ` " --namespace-name ${{ parameters.Namespace }}"
      Write-Host "Running Kiota command:"
      Write-Host "----------------------------------------"
      Write-Host $cmd
      Write-Host "----------------------------------------"
      Invoke-Expression $cmd
    displayName: 'Generate Kiota client ${{ parameters.GeneratedApiClassName }}'
